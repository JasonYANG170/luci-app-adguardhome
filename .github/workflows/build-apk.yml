name: Build APK for OpenWrt 25.12

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build APK Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gettext git rsync

      - name: Create Package Structure
        run: |
          mkdir -p apk-build/usr/lib/lua/luci
          mkdir -p apk-build/etc
          mkdir -p apk-build/usr/share
          mkdir -p apk-build/www
          
          # 复制文件
          if [ -d "luasrc" ]; then
            cp -r luasrc/* apk-build/usr/lib/lua/luci/
          fi
          
          if [ -d "root/etc" ]; then
            cp -r root/etc/* apk-build/etc/
          fi
          
          if [ -d "root/usr/share" ]; then
            cp -r root/usr/share/* apk-build/usr/share/
          fi
          
          if [ -d "root/www" ]; then
            cp -r root/www/* apk-build/www/
          fi

      - name: Create Package Info
        run: |
          cat > apk-build/.PKGINFO <<EOF
          pkgname = luci-app-adguardhome
          pkgver = 1.8-12
          pkgdesc = LuCI Support for AdGuard Home
          url = https://github.com/JasonYANG170/luci-app-adguardhome
          builddate = $(date +%s)
          packager = GitHub Actions
          size = $(du -sb apk-build | cut -f1)
          arch = all
          origin = luci-app-adguardhome
          depend = wget-ssl
          license = Apache-2.0
          EOF

      - name: Create Archive
        run: |
          cd apk-build
          tar -czf ../luci-app-adguardhome_1.8-12_all.apk .
          cd ..

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-adguardhome-apk
          path: luci-app-adguardhome_1.8-12_all.apk

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: luci-app-adguardhome-apk
          path: release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.apk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
